# tasks/master.yml
---
# 1) Ensure the SSH directory exists
- name: Ensure /home/pfe/.ssh exists on master
  file:
    path: /home/pfe/.ssh
    state: directory
    owner: pfe
    group: pfe
    mode: '0700'

# 2) Generate keypair if missing
- name: Generate SSH keypair for pfe (if missing)
  become_user: pfe
  command: ssh-keygen -t rsa -b 4096 -f /home/pfe/.ssh/id_rsa -N ''
  args:
    creates: /home/pfe/.ssh/id_rsa

# 3) Fix permissions on the keys
- name: Set permissions on private key
  file:
    path: /home/pfe/.ssh/id_rsa
    owner: pfe
    group: pfe
    mode: '0600'

- name: Set permissions on public key
  file:
    path: /home/pfe/.ssh/id_rsa.pub
    owner: pfe
    group: pfe
    mode: '0644'

# 4) Read the public key into a fact
- name: Read controller public key
  slurp:
    src: /home/pfe/.ssh/id_rsa.pub
  register: slurped_master_pubkey

- name: Expose controller_pubkey fact
  set_fact:
    controller_pubkey: "{{ slurped_master_pubkey.content | b64decode }}"

# 5) Install & configure container runtime
- name: Install required packages
  block:
    - name: Install containerd
      yum:
        name: containerd
        state: present

    - name: Enable and start containerd
      systemd:
        name: containerd
        enabled: yes
        state: started

    - name: Create containerd config directory
      file:
        path: /etc/containerd
        state: directory

    - name: Generate containerd default config
      command: containerd config default
      register: containerd_config
      changed_when: false

    - name: Apply SystemdCgroup setting
      copy:
        dest: /etc/containerd/config.toml
        content: "{{ containerd_config.stdout | regex_replace('SystemdCgroup = false', 'SystemdCgroup = true') }}"

    - name: Restart containerd
      systemd:
        name: containerd
        state: restarted

# 6) Install & enable Kubernetes components
- name: Install Kubernetes components
  block:
    - name: Add Kubernetes repo
      yum_repository:
        name: kubernetes
        description: Kubernetes RPM Repository
        baseurl: https://pkgs.k8s.io/core:/stable:/v1.29/rpm/
        gpgkey: https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key
        gpgcheck: yes
        repo_gpgcheck: yes
        enabled: yes

    - name: Install kubelet, kubeadm, kubectl
      yum:
        name:
          - kubelet-{{ kube_version }}
          - kubeadm-{{ kube_version }}
          - kubectl-{{ kube_version }}
        state: present

    - name: Enable kubelet
      systemd:
        name: kubelet
        enabled: yes

# 7) Initialize the control plane
- name: Initialize cluster
  block:
    - name: Create kubeadm config file
      template:
        src: templates/kubeadm-config.j2
        dest: /tmp/kubeadm-config.yaml

    - name: Initialize control plane
      command: >
        kubeadm init
        --config=/tmp/kubeadm-config.yaml
        --ignore-preflight-errors=Swap
        --upload-certs
      register: kubeadm_init
      args:
        creates: /etc/kubernetes/admin.conf

    - name: Configure kubectl for pfe
      become_user: pfe
      shell: |
        mkdir -p /home/pfe/.kube
        cp -f /etc/kubernetes/admin.conf /home/pfe/.kube/config
        chown pfe:pfe /home/pfe/.kube/config

    - name: Generate worker join command
      shell: kubeadm token create --print-join-command > /tmp/join-command.sh
      args:
        creates: /tmp/join-command.sh

    - name: Install Flannel CNI
      shell: kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

    - name: Verify join command exists
      stat:
        path: /tmp/join-command.sh
      register: join_cmd_file
      failed_when: not join_cmd_file.stat.exists
